<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="robots" content="all"> <meta name="google-site-verification" content="8wzYblVUAwjDGn2yb7nky80HsnYb5vQ0aeaolOCv3Is"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Estimating encoder velocity | Christopher Mailer</title> <meta name="author" content="Christopher Mailer"> <meta name="description" content="A better way to estimate velocity with quadrature encoders."> <meta name="keywords" content="chrismailer, christopher, mailer, africa, profile, portfolio, engineering, design, research, robotics, mechatronics"> <meta property="og:site_name" content="Estimating encoder velocity | Christopher Mailer"> <meta property="og:type" content="website"> <meta property="og:title" content="Estimating encoder velocity | Christopher Mailer"> <meta property="og:url" content="https://chrismailer.github.io/blog/2022/velocity-estimator/"> <meta property="og:description" content="A better way to estimate velocity with quadrature encoders."> <meta property="og:image" content="/assets/img/profile.jpeg"> <meta property="og:locale" content="en"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Estimating encoder velocity"> <meta name="twitter:description" content="A better way to estimate velocity with quadrature encoders."> <meta name="twitter:image" content="/assets/img/profile.jpeg"> <script type="application/ld+json">
      {
        "author":
        {
          "@type": "Person",
          "name": "Christopher  Mailer"
        },
        "url": "https://chrismailer.github.io/blog/2022/velocity-estimator/",
        "@type": "WebSite",
        "description": "A better way to estimate velocity with quadrature encoders.",
        "headline": "Estimating encoder velocity",
        "sameAs": ["https://scholar.google.com/citations?user=lDH4KnUAAAAJ", "https://github.com/chrismailer", "https://www.linkedin.com/in/chrismailer"],
        "name": "Christopher  Mailer",
        "@context": "https://schema.org"
      }
    </script> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-228.png" sizes="228x228"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-128.png" sizes="128x128"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-96.png" sizes="96x96"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-76.png" sizes="76x76"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-57.png" sizes="57x57"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/assets/favicon/favicon-16.png" sizes="16x16"> <link rel="apple-touch-icon" href="/assets/favicon/favicon-180.png" sizes="180x180"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://chrismailer.github.io/blog/2022/velocity-estimator/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Christopher </span>Mailer</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">projects<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Estimating encoder velocity</h1> <p class="post-meta">May 23, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/category/electronics"> <i class="fas fa-tag fa-sm"></i> Electronics</a>   <a href="/blog/category/control"> <i class="fas fa-tag fa-sm"></i> Control</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I stumbled upon this really interesting method for getting smooth estimates for encoder position and velocity from discrete quadrature encoders. It’s talked about <a href="https://www.embeddedrelated.com/showarticle/530.php" rel="external nofollow noopener" target="_blank">here</a> and it’s also used in the ODrive motor controller firmware, but I thought a nice explanatory post might be a useful contribution. It uses a tracking loop to follow the encoder measurement with a PI feedback loop and finite bandwidth. What you end up with is tunable filtered position and velocity estimates which you can feed into a controller.</p> <p>For some background and context as to why encoder velocity estimation is not trivial, quadrature encoders track position and direction by sensing evenly spaced markings on tracks, kind of like measuring distance by counting paces except on a much smaller scale. On the rotary encoders I have worked with these markings are made with either tiny gaps cut into a metal disk or incredibly small opaque patches etched onto a glass disk, and are picked up with an array of IR sensors to detect whether the light passes through the disk or is blocked. These markings can get mind-blowingly small. Typically two tracks of markings 90° out of phase are used which has two benefits.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>               _______         _______       
Track A ______|       |_______|       |______
           _______         _______         __
Track B __|       |_______|       |_______|  
</code></pre></div></div> <ol> <li>Resolution is doubled without gaps needing to be manufactured smaller.</li> <li>Direction can be detected based on which track leads or lags. (Mainly this one)</li> </ol> <p>Measuring the angular position and direction of an encoder is straightforward and can be done by using a microcontroller to keep count of the rising and falling edges for each of the tracks. Position is only known accurately at each edge, which for most applications is fine. Typically people assume a zero-order hold and recycle the same position measurement until the next edge is detected.</p> <p>However, this becomes problematic when trying to estimate the velocity of the encoder. Average velocity is calculated using \(\frac{\Delta x}{\Delta t}\) and with this discrete system you have the option of fixing either \(\Delta x\) or \(\Delta t\).</p> <p>A fixed \(\Delta t\) or sample frequency is often the easiest implementation on a microcontroller, but becomes an issue for low resolution encoders or slow movements when the \(\Delta t\) is significantly smaller than the time between pulses. With multiple samples between edges this results in a stream of zero speed measurements followed by a velocity spike when an edge is detected and then more zero’s - not ideal for control.</p> <p>Alternatively a fixed \(\Delta x\) is a bit harder to implement needing a hardware timer to measure the \(\Delta t\) between pulses, but will provide the most accurate velocity average from the given information. This approach has problems with very high resolution encoders and fast speeds where more and more microcontroller clock cycles will be spent in interrupt handlers. Also the stationary case where the timer will overflow needs to be handled separately and often you might not be able to hook the encoder up to a fast timer if separate hardware is tracking encoder pulses.</p> <p>Also need to mention that discrete position measurements and noisy velocity values result in pretty rough control and just arbitrarily filtering these values is never a good approach.</p> <h2 id="tracking-loop">Tracking loop</h2> <p>There is a very neat alternative to both of these methods which uses a tracking loop and feedback to follow the encoder pulses. This method is used in the ODrive motor controller firmware and is also talked about <a href="https://www.embeddedrelated.com/showarticle/530.php" rel="external nofollow noopener" target="_blank">here</a>. The tracking bandwidth can be adjusted for the encoder resolution and anticipated speed. Because it is a PI loop is has the benefit of providing both position and velocity estimates between encoder edges. Also handling the stationary case comes for free and it is not a headache to implement.</p> <p>This is all the C++ code you need.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">PLL</span><span class="o">::</span><span class="n">update</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">encoder_pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">position</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">velocity</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">pos_error</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">encoder_pos</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">position</span><span class="p">));</span>
    <span class="n">position</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Kp</span> <span class="o">*</span> <span class="n">pos_error</span><span class="p">;</span>
    <span class="n">velocity</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Ki</span> <span class="o">*</span> <span class="n">pos_error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>The position and velocity variables have units of <code class="language-plaintext highlighter-rouge">counts</code> and <code class="language-plaintext highlighter-rouge">counts/s</code>. This feedback loop update needs to be called fast enough to meet the desired tracking bandwidth. ODrive runs it at 20kHz which seems good enough for most applications.</p> <h2 id="selecting-kp-and-ki">Selecting Kp and Ki</h2> <p>The gains for the PI tracking loop are selected to ensure the response is critically damped - fast with no oscillations. The system can be written in the linear time-invariant form.</p> \[\mathbf{\dot{x}}(t) = \mathbf{A}\mathbf{x}(t) + \mathbf{B}\mathbf{u}(t)\] <p>Like this where \(p_e\) is the count from the encoder.</p> \[\begin{bmatrix} \dot{p} \\ \dot{v} \end{bmatrix} = \begin{bmatrix} -Kp &amp; 1 \\ -Ki &amp; 0 \end{bmatrix}\begin{bmatrix} p \\ v \end{bmatrix} + \begin{bmatrix} Kp \\ Ki \end{bmatrix} \begin{bmatrix} p_e \\ 0 \end{bmatrix}\] <p>By looking at the eigenvalues of the \(\mathbf{A}\) matrix we can place the poles and determine the natural response of the system.</p> \[poles = eig(\mathbf{A}) = \frac{-Kp}{2} \pm \frac{\sqrt{Kp^2-4Ki}}{2}i\] <p>For tracking to be critically damped the imaginary component should be zero, and the real component will determine the responsiveness or bandwidth of the tracking.</p> \[Ki = \frac{Kp^2}{4}\] \[Kp = 2\cdot Bandwidth\] </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/kemba/">Kemba: A hybrid legged robot</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/hopper/">A hopping robot</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/shunt/">A simple motor shunt regulator</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/boom/">Planarising boom for legged robots</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/hexapod-adapt/">Hexapod: Adapting like an animal</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Christopher Mailer. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-7CBDKZFSBL"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7CBDKZFSBL");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>