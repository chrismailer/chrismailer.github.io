<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://chrismailer.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://chrismailer.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2023-07-03T18:02:36+00:00</updated><id>https://chrismailer.github.io/feed.xml</id><title type="html">blank</title><subtitle>A website about me and my projects</subtitle><entry><title type="html">Kemba: A hybrid legged robot</title><link href="https://chrismailer.github.io/blog/2022/kemba/" rel="alternate" type="text/html" title="Kemba: A hybrid legged robot"/><published>2022-12-27T10:00:00+00:00</published><updated>2022-12-27T10:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2022/kemba</id><content type="html" xml:base="https://chrismailer.github.io/blog/2022/kemba/"><![CDATA[<p>For my masters in UCT’s <a href="https://www.africanroboticsunit.com">robotics lab</a> I built and designed the control algorithms for a legged robot which we affectionately called Kemba. The design, simulation and control aspects of this project are best documented in my <a href="https://chrismailer.github.io/assets/pdf/mailer-masters-thesis.pdf">MSc thesis</a>. Our goal with Kemba was to combine the best of two actuation schemes with pneumatically actuated knees for simple, powerful, compliant, and impact resistant actuation, and proprioceptive electric actuators at the shoulder and hip for high bandwidth torque control and foot placement. Kemba is capable of bounding at up to 1.7m/s with a full flight phase, jumping just under 1m high (2.2 times it’s nominal leg length), and accelerating from rest into a top speed bound in only 2 strides and under half a second.</p> <p>Here are videos of Kemba accelerating from rest and bounding around the lab on the <a href="https://chrismailer.github.io/projects/boom/">planarising boom</a> I also built.</p> <div class="row justify-content-sm-center"> <div class="col-sm-6 mt-3 mt-md-0"> <div class="embed-container"> <iframe width="640" height="390" src="https://www.youtube.com/embed/KZ1mVP8R52g" frameborder="0" allowfullscreen=""></iframe> </div> <style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style> </div> <div class="col-sm-6 mt-3 mt-md-0"> <div class="embed-container"> <iframe width="640" height="390" src="https://www.youtube.com/embed/u2Hn26uojoM" frameborder="0" allowfullscreen=""></iframe> </div> <style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style> </div> </div> <div class="caption"> A video of the robot accelerating from rest directly into a fast bound and running around the lab on the planarising boom. </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/leg-parts-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/leg-parts-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/leg-parts-1400.webp"/> <img src="/assets/img/kemba/leg-parts.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Freshly machined aluminium parts for the legs. </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/leg-open-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/leg-open-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/leg-open-1400.webp"/> <img src="/assets/img/kemba/leg-open.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Partially disassembled leg with second femur half removed showing piston closed kinematic chain arrangement. </div> <div class="row justify-content-sm-center"> <div class="col-sm-9 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/tibia-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/tibia-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/tibia-1400.webp"/> <img src="/assets/img/kemba/tibia.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-3 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/tibia-section-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/tibia-section-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/tibia-section-1400.webp"/> <img src="/assets/img/kemba/tibia-section.jpeg" class="img-fluid rounded" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Tibia with press fit bearings and foot (Left) and section view showing I-beam cross section (Right). </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/femur-halves-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/femur-halves-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/femur-halves-1400.webp"/> <img src="/assets/img/kemba/femur-halves.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Separated femur halves with inserted steel knee shaft showing internal thin walled box shape and fastener bosses. </div> <div class="row justify-content-sm-center"> <div class="col-sm-8 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/knee-joint-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/knee-joint-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/knee-joint-1400.webp"/> <img src="/assets/img/kemba/knee-joint.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-4 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/knee-section-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/knee-section-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/knee-section-1400.webp"/> <img src="/assets/img/kemba/knee-section.jpeg" class="img-fluid rounded" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Exposed knee joint (Left) and cross section (Right) showing the bearings in red, tibia in green, femur in blue, and hollow steel knee shaft in yellow. </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/body-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/body-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/body-1400.webp"/> <img src="/assets/img/kemba/body.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Sheet metal halves which make up the front (Top) and back (Bottom) of the body with mounted hip motors, solenoid valves, and signal DIN connectors. </div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/gim-motor-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/gim-motor-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/gim-motor-1400.webp"/> <img src="/assets/img/kemba/gim-motor.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/gim-rotor-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/gim-rotor-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/gim-rotor-1400.webp"/> <img src="/assets/img/kemba/gim-rotor.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/kemba/gim-inside-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/kemba/gim-inside-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/kemba/gim-inside-1400.webp"/> <img src="/assets/img/kemba/gim-inside.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> GIM8115-6 actuator (Left) with casing removed to show the back of the rotor (Middle) and it’s large 19mm stack length (Right). </div>]]></content><author><name></name></author><category term="Mechanical"/><category term="Electronics"/><category term="Robotics"/><summary type="html"><![CDATA[My masters thesis project]]></summary></entry><entry><title type="html">A hopping robot</title><link href="https://chrismailer.github.io/blog/2022/hopper/" rel="alternate" type="text/html" title="A hopping robot"/><published>2022-11-25T10:00:00+00:00</published><updated>2022-11-25T10:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2022/hopper</id><content type="html" xml:base="https://chrismailer.github.io/blog/2022/hopper/"><![CDATA[<h2 id="introduction">Introduction</h2> <div class="row"> <div class="col-sm-3 mt-3 mt-md-0"></div> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/hopper/cover-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/hopper/cover-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/hopper/cover-1400.webp"/> <img src="/assets/img/hopper/cover.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-3 mt-3 mt-md-0"></div> </div> <div class="caption"> Redesigned hopper mounted on the boom. </div> <p>At the end of 2019 I built a 2kg hopping robot for a PhD researcher as part of a 6-week internship for the UCT Robotics Lab. When I joined the lab full-time I took over the project again and ported the system over to the Lab’s new Simulink Real-Time Target Machine using the CAN communication protocol, implemented impedance control, and built the Raibert-based control system for consistent hopping and velocity control. You can see the robot hopping and reacting to pushes in this video while it tries to stay in the same spot.</p> <div class="embed-container"> <iframe width="640" height="390" src="https://www.youtube.com/embed/VbLtQkqtwZ0" frameborder="0" allowfullscreen=""></iframe> </div> <style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style> <p>This video shows the first version of the hopper. I also built a newer version working part-time alongside my masters which used improved actuators, had stronger and more rigid legs, and a much simpler and lighter design.</p> <h2 id="leg-impedance-control">Leg Impedance Control</h2> <div class="row"> <div class="col-sm-3 mt-3 mt-md-0"></div> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/hopper/leg-kinematics-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/hopper/leg-kinematics-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/hopper/leg-kinematics-1400.webp"/> <img src="/assets/img/hopper/leg-kinematics.jpg" class="img-fluid rounded" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-3 mt-3 mt-md-0"></div> </div> <div class="caption"> Kinematic diagram of the Hopper v2 leg </div> <p>For dynamic robots like the hopper, controlling the force produced at the foot, and thus the body acceleration, is far more important than precisely controlling foot position. For this reason the leg is controlled with an impedance (force) controller in polar coordinates with a radial length \(r\) and an angle \(\phi\) from the body to the ankle, kind of like a pogo stick. Force in this polar frame is controlled by computing the required left \(\tau_L\) and right \(\tau_R\) motor torques from the desired radial force \(F_r\) and torque \(\tau_{\phi}\) using the leg polar Jacobian \(J_p\) calculated from the leg forward kinematics.</p> \[\begin{bmatrix} \tau_L \\ \tau_R \end{bmatrix} = J_p^T \begin{bmatrix} F_r \\ \tau_\phi \end{bmatrix}\] <p>This ignores the mass and dynamics of the legs, but is still a reasonable approximation as the links are relatively light. A PD controller on each of the polar axes enables tracking of desired position and velocity setpoints \(r_0\), \(\phi_0\) and \(\dot{r}_0\), \(\dot{\phi}_0\).</p> \[F_r = K_p(r_0 - r_{leg}) + Kd_r(\dot{r_0} - \dot{r_{leg}}) + F_{thrust}\] \[\tau_{\phi} = Kp_{\phi}(\phi_0 - \phi_{leg}) + Kd_{\phi}(\dot{\phi_0} - \dot{\phi_{leg}})\] <p>These PD controllers behave like a parallel spring and damper where \(Kp\) is the spring stiffness with units \(\frac{N}{m}\) or \(\frac{Nm}{rad}\) and \(Kd\) is the damping constant with units \(\frac{Ns}{m}\) or \(\frac{Nms}{rad}\). The radial stiffness determines how much the leg compresses during landing. Higher jump heights will need higher radial stiffness to stop the leg bottoming out (think pogo stick). The polar angle stiffness determines how quickly the leg repositions during flight. The damping constants are typically set to keep the axes more or less critically damped and avoid any oscillations.</p>]]></content><author><name></name></author><category term="Mechanical"/><category term="Electronics"/><category term="Robotics"/><summary type="html"><![CDATA[A legged research platform]]></summary></entry><entry><title type="html">A simple motor shunt regulator</title><link href="https://chrismailer.github.io/blog/2022/shunt/" rel="alternate" type="text/html" title="A simple motor shunt regulator"/><published>2022-08-16T00:00:00+00:00</published><updated>2022-08-16T00:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2022/shunt</id><content type="html" xml:base="https://chrismailer.github.io/blog/2022/shunt/"><![CDATA[<p>Two of the legged robots I have worked on use low Kv BLDC motors coupled to a planetary gearbox as their actuators like the Mini Cheetah actuators. These actuators are great, but have a small problem when running from the lab power supply rather than a battery pack. When doing negative work the motors will back-feed the power supply, raising the voltage on the output filtering capacitors and triggering the over voltage protection. This has resulted in many of the robots shutting down and collapsing in a rather dramatic fashion.</p> <p>To solve this I built an automatic shunt regulator based off of the one I saw on the open-source <a href="https://odriverobotics.com/">ODrive</a> motor controller. I tried to buy a hobby one online but the <a href="https://www.pololu.com/category/249/shunt-regulators">biggest I could find</a> was rate for an anemic 15W and only went up to 33V, not the 48V we needed. Plus I thought it would be interesting to try and make one.</p> <p>The shunt regulator works by monitoring the bus voltage and dumping the energy from the motors into a 50W 0.47Ω power resistor, essentially acting as a variable load to regulate the voltage. A microcontroller monitors the bus voltage with a voltage divider and modulates the amount of power going into the brake resistor by varying the duty cycle of a 20kHz PWM signal switching a MOSFET. The gate driver quickly charges the gate capacitance and ensures the MOSFET is turned on hard, minimizing power dissipation during conduction.</p> <div class="row"> <div class="col-sm-2 mt-3 mt-md-0"></div> <div class="col-sm-8 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/shunt/schematic-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/shunt/schematic-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/shunt/schematic-1400.webp"/> <img src="/assets/img/shunt/schematic.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-2 mt-3 mt-md-0"></div> </div> <div class="caption"> Simplified schematic of the shunt regulator circuit. It isn't shown here, but I also included a large flyback diode in parallel with the power resistor. </div> <p>The reason for the PWM signal is to be able to modulate the amount of power dissipation rather than dumping the maximum possible power of over 1.2kW for only a small rise in voltage. The PWM signal is controlled with this simple proportional controller where current to the brake resistor is increased proportionally based on the bus voltage providing a smooth fade in or out of power dissipation. Here’s the C code snippet running on the micro.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">brake_duty</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">((</span><span class="n">v_bus</span> <span class="o">-</span> <span class="n">v_ramp_start</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v_ramp_end</span> <span class="o">-</span> <span class="n">v_ramp_start</span><span class="p">),</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">),</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">);</span>
</code></pre></div></div> <p>By configuring <code class="language-plaintext highlighter-rouge">v_ramp_start</code> and <code class="language-plaintext highlighter-rouge">v_ramp_end</code> in the firmware the supply voltage and responsiveness to voltage spikes can be adjusted.</p> <div class="row"> <div class="col-sm-3 mt-3 mt-md-0"></div> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/shunt/cover-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/shunt/cover-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/shunt/cover-1400.webp"/> <img src="/assets/img/shunt/cover.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-3 mt-3 mt-md-0"></div> </div> <div class="caption"> Working circuit on prototype board. </div> <p>You can’t see it in this image of the board, but I also soldered a thick single core copper wire to the main power rails underneath just because pushing 40A through proto board tracks didn’t seem like a great idea. I never got around to designing a PCB for this and making the circuit more robust, but that could be a fun future project.</p>]]></content><author><name></name></author><category term="Electronics"/><category term="Control"/><summary type="html"><![CDATA[An automatic shunt regulator for dissipating motor regen power]]></summary></entry><entry><title type="html">Estimating encoder velocity</title><link href="https://chrismailer.github.io/blog/2022/velocity-estimator/" rel="alternate" type="text/html" title="Estimating encoder velocity"/><published>2022-05-23T00:00:00+00:00</published><updated>2022-05-23T00:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2022/velocity-estimator</id><content type="html" xml:base="https://chrismailer.github.io/blog/2022/velocity-estimator/"><![CDATA[<p>I stumbled upon this really interesting method for getting smooth estimates for encoder position and velocity from discrete quadrature encoders. It’s talked about <a href="https://www.embeddedrelated.com/showarticle/530.php">here</a> and it’s also used in the ODrive motor controller firmware, but I thought a nice explanatory post might be a useful contribution. It uses a tracking loop to follow the encoder measurement with a PI feedback loop and finite bandwidth. What you end up with is tunable filtered position and velocity estimates which you can feed into a controller.</p> <p>For some background and context as to why encoder velocity estimation is not trivial, quadrature encoders track position and direction by sensing evenly spaced markings on tracks, kind of like measuring distance by counting paces except on a much smaller scale. On the rotary encoders I have worked with these markings are made with either tiny gaps cut into a metal disk or incredibly small opaque patches etched onto a glass disk, and are picked up with an array of IR sensors to detect whether the light passes through the disk or is blocked. These markings can get mind-blowingly small. Typically two tracks of markings 90° out of phase are used which has two benefits.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>               _______         _______       
Track A ______|       |_______|       |______
           _______         _______         __
Track B __|       |_______|       |_______|  
</code></pre></div></div> <ol> <li>Resolution is doubled without gaps needing to be manufactured smaller.</li> <li>Direction can be detected based on which track leads or lags. (Mainly this one)</li> </ol> <p>Measuring the angular position and direction of an encoder is straightforward and can be done by using a microcontroller to keep count of the rising and falling edges for each of the tracks. Position is only known accurately at each edge, which for most applications is fine. Typically people assume a zero-order hold and recycle the same position measurement until the next edge is detected.</p> <p>However, this becomes problematic when trying to estimate the velocity of the encoder. Average velocity is calculated using \(\frac{\Delta x}{\Delta t}\) and with this discrete system you have the option of fixing either \(\Delta x\) or \(\Delta t\).</p> <p>A fixed \(\Delta t\) or sample frequency is often the easiest implementation on a microcontroller, but becomes an issue for low resolution encoders or slow movements when the \(\Delta t\) is significantly smaller than the time between pulses. With multiple samples between edges this results in a stream of zero speed measurements followed by a velocity spike when an edge is detected and then more zero’s - not ideal for control.</p> <p>Alternatively a fixed \(\Delta x\) is a bit harder to implement needing a hardware timer to measure the \(\Delta t\) between pulses, but will provide the most accurate velocity average from the given information. This approach has problems with very high resolution encoders and fast speeds where more and more microcontroller clock cycles will be spent in interrupt handlers. Also the stationary case where the timer will overflow needs to be handled separately and often you might not be able to hook the encoder up to a fast timer if separate hardware is tracking encoder pulses.</p> <p>Also need to mention that discrete position measurements and noisy velocity values result in pretty rough control and just arbitrarily filtering these values is never a good approach.</p> <h2 id="tracking-loop">Tracking loop</h2> <p>There is a very neat alternative to both of these methods which uses a tracking loop and feedback to follow the encoder pulses. This method is used in the ODrive motor controller firmware and is also talked about <a href="https://www.embeddedrelated.com/showarticle/530.php">here</a>. The tracking bandwidth can be adjusted for the encoder resolution and anticipated speed. Because it is a PI loop is has the benefit of providing both position and velocity estimates between encoder edges. Also handling the stationary case comes for free and it is not a headache to implement.</p> <p>This is all the C++ code you need.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">PLL</span><span class="o">::</span><span class="n">update</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">encoder_pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">position</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">velocity</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">pos_error</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">encoder_pos</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">position</span><span class="p">));</span>
    <span class="n">position</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Kp</span> <span class="o">*</span> <span class="n">pos_error</span><span class="p">;</span>
    <span class="n">velocity</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Ki</span> <span class="o">*</span> <span class="n">pos_error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>The position and velocity variables have units of <code class="language-plaintext highlighter-rouge">counts</code> and <code class="language-plaintext highlighter-rouge">counts/s</code>. This feedback loop update needs to be called fast enough to meet the desired tracking bandwidth. ODrive runs it at 20kHz which seems good enough for most applications.</p> <h2 id="selecting-kp-and-ki">Selecting Kp and Ki</h2> <p>The gains for the PI tracking loop are selected to ensure the response is critically damped - fast with no oscillations. The system can be written in the linear time-invariant form.</p> \[\mathbf{\dot{x}}(t) = \mathbf{A}\mathbf{x}(t) + \mathbf{B}\mathbf{u}(t)\] <p>Like this where \(p_e\) is the count from the encoder.</p> \[\begin{bmatrix} \dot{p} \\ \dot{v} \end{bmatrix} = \begin{bmatrix} -Kp &amp; 1 \\ -Ki &amp; 0 \end{bmatrix}\begin{bmatrix} p \\ v \end{bmatrix} + \begin{bmatrix} Kp \\ Ki \end{bmatrix} \begin{bmatrix} p_e \\ 0 \end{bmatrix}\] <p>By looking at the eigenvalues of the \(\mathbf{A}\) matrix we can place the poles and determine the natural response of the system.</p> \[poles = eig(\mathbf{A}) = \frac{-Kp}{2} \pm \frac{\sqrt{Kp^2-4Ki}}{2}i\] <p>For tracking to be critically damped the imaginary component should be zero, and the real component will determine the responsiveness or bandwidth of the tracking.</p> \[Ki = \frac{Kp^2}{4}\] \[Kp = 2\cdot Bandwidth\]]]></content><author><name></name></author><category term="Electronics"/><category term="Control"/><summary type="html"><![CDATA[A better way to estimate velocity with quadrature encoders.]]></summary></entry><entry><title type="html">Planarising boom for legged robots</title><link href="https://chrismailer.github.io/blog/2021/boom/" rel="alternate" type="text/html" title="Planarising boom for legged robots"/><published>2021-06-17T21:00:00+00:00</published><updated>2021-06-17T21:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2021/boom</id><content type="html" xml:base="https://chrismailer.github.io/blog/2021/boom/"><![CDATA[<div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/render-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/render-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/render-1400.webp"/> <img src="/assets/img/boom/render.jpg" class="img-fluid rounded" width="auto" height="auto" title="CAD rendering of the boom" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> CAD rendering of the boom. </div> <p>In the UCT Robotics Lab we have a number of legged robots which run around in the experimental area. To help them balance and provide state information for control I built a custom 2.5m carbon fibre planar support boom. The design and software for the boom is documented in a section of my <a href="https://chrismailer.github.io/assets/pdf/mailer-masters-thesis.pdf">thesis</a>.</p> <p>The boom uses two tensioned steel cables in a parallelogram arrangement to always keep the end vertical. A Kalman filter fuses state data from the IMU on the end and the high-resolution encoders at the base to estimate the robot position, velocity, and acceleration.</p> <p>All of the parts I designed were machined in-house at UCT’s workshop. Tight tollerances were particularly important as any slop in the joints would introduce errors into the state estimates. The parts were machined from 6061 aluminium and 304 stainless steel.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/parts-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/parts-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/parts-1400.webp"/> <img src="/assets/img/boom/parts.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="image title" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Freshly machined parts for the boom. </div> <p>To maximise both torsional and lateral rigidity, while remaining as light as possible, the boom arm is a large diameter thin walled tube, maximising the polar moment of inertia. The arm is 2.5m long and is constructed from 3 pieces of 60mm outer diameter carbon fibre tube with a wall thickness of 1.5 mm.</p> <div class="row justify-content-sm-center"> <div class="col-sm-7 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/cf-tubes-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/cf-tubes-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/cf-tubes-1400.webp"/> <img src="/assets/img/boom/cf-tubes.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-5 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/end-exposed-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/end-exposed-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/end-exposed-1400.webp"/> <img src="/assets/img/boom/end-exposed.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Carbon fibre tubes used in the boom arm (Left) and data cables routed through the boom end (Right). </div> <p>The boom was designed with interchangable mounting ends as some of the robots require the ability to pivot about the end while other needs to be rigidly attached. An incremental optical encoder is incorporated into the pivot enabled end to measure the movement of this additional degree of freedom. An accelerometer is mounted to both mounting ends.</p> <div class="row justify-content-sm-center"> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/end-pivot-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/end-pivot-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/end-pivot-1400.webp"/> <img src="/assets/img/boom/end-pivot.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-6 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/end-fixed-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/end-fixed-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/end-fixed-1400.webp"/> <img src="/assets/img/boom/end-fixed.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Interchangeable boom end configurations each with their own accelerometer. </div> <p>The hollow stainless steel shafts for the elevation axis on the end insert from either side to preload the bearings in a back-to-back configuration and remove any axial slop in the joint.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/end-render-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/end-render-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/end-render-1400.webp"/> <img src="/assets/img/boom/end-render.jpg" class="img-fluid rounded" width="auto" height="auto" title="image title" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Section view of the elevation and roll axes on the boom mounting end. Bearings are shown in red and the hollow stainless steel shafts are shown in yellow. </div> <p>The centre pivot of the boom serves a stable base which the robot will run around, as well as the primary two degrees of freedom. An incremental quadrature encoder is mounted to each of the axes, geared with a 6mm wide MXL profile timing belt for a 4:1 gear ratio to further increase angular resolution.</p> <div class="row justify-content-sm-center"> <div class="col-sm-7 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/centre-joint-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/centre-joint-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/centre-joint-1400.webp"/> <img src="/assets/img/boom/centre-joint.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm-5 mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/boom/centre-joint-render-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/boom/centre-joint-render-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/boom/centre-joint-render-1400.webp"/> <img src="/assets/img/boom/centre-joint-render.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" title="example image" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Centre pivot with encoders and 4:1 timing belt reduction (Left), and sectioned view (Right) of the elevation axis joint showing stainless steel shafts in yellow and bearings in red. </div> <p>Here you can see the boom doing its thing while <a href="https://chrismailer.github.io/projects/kemba/">Kemba</a> bounds around the lab.</p> <div class="embed-container"> <iframe width="640" height="390" src="https://www.youtube.com/embed/u2Hn26uojoM" frameborder="0" allowfullscreen=""></iframe> </div> <style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style>]]></content><author><name></name></author><category term="Mechanical"/><category term="Electronics"/><summary type="html"><![CDATA[Building a support and state feedback boom for legged robots]]></summary></entry><entry><title type="html">Hexapod: Adapting like an animal</title><link href="https://chrismailer.github.io/blog/2020/hexapod-adapt/" rel="alternate" type="text/html" title="Hexapod: Adapting like an animal"/><published>2020-11-15T00:00:00+00:00</published><updated>2020-11-15T00:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2020/hexapod-adapt</id><content type="html" xml:base="https://chrismailer.github.io/blog/2020/hexapod-adapt/"><![CDATA[<p>In our final year of engineering at UCT we have the opportunity to spend the year doing a project we are interested in alongside our coursework under the guidance of an academic advisor. For my project I adapted the work from the paper <a href="https://doi.org/10.1038/nature14422">Robots that can adapt like animals</a> to make a hexapod robot learn how to quickly adapt to a broken leg. The project is best documented in my <a href="https://chrismailer.github.io/assets/pdf/mailer-bachelors-thesis.pdf">thesis</a>. I also published a <a href="https://dl.acm.org/doi/abs/10.1145/3449639.3459271">paper</a> on the work.</p> <p>For this project I built a physically realistic simulation of the robot using the <a href="https://pybullet.org/wordpress/">Bullet</a> physics engine. You can find the simulation code <a href="https://github.com/chrismailer/hexapod-sim">here</a>. Using the simulator, approximately 40 million walking simulations were run on South Africa’s 1.3 petaFLOPS Lengau cluster to find different ways of walking which used each of the legs in different amounts.</p> <p>The 55 thousands hours of walking in simulation produce an experience map which was then transferred to the physcial hardware enabeling it to change the way it walks and adapt to external influences such as hardware failure or different terrain. The robot adapts quickly by trying gaits in the experience map, and based on its actual performance updates what walking behaviours it thinks will do better than others.</p> <div class="embed-container"> <iframe width="640" height="390" src="https://www.youtube.com/embed/3KyUpPa7iBk" frameborder="0" allowfullscreen=""></iframe> </div> <style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style>]]></content><author><name></name></author><category term="Programming"/><summary type="html"><![CDATA[My bachelors thesis project]]></summary></entry><entry><title type="html">S.A Agulhas II Ice Claw</title><link href="https://chrismailer.github.io/blog/2019/claw/" rel="alternate" type="text/html" title="S.A Agulhas II Ice Claw"/><published>2019-08-06T00:00:00+00:00</published><updated>2019-08-06T00:00:00+00:00</updated><id>https://chrismailer.github.io/blog/2019/claw</id><content type="html" xml:base="https://chrismailer.github.io/blog/2019/claw/"><![CDATA[<p>For this project a group of 4 of us won a proposal at the end of 2018 from the Polar Arctic Research Group to design a better system for picking up large ice floes onto the S.A Agulhas II for core sample drilling. The S.A Agulhas II is a research vessel and polar supply ship which takes researches, equipment and supplies down to Marion Island and the Antarctic Ice Shelf bases. It is famously known for being the mother ship for the Endurance22 Expedition when Sir Ernest Shackleton’s ship, Endurance was found.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/claw/agulhas-iceshelf-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/claw/agulhas-iceshelf-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/claw/agulhas-iceshelf-1400.webp"/> <img src="/assets/img/claw/agulhas-iceshelf.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> S.A. Agulhas II parked alongside the Antarctic ice shelf. </div> <p>Ice floes are large pancake shaped pieces of ice which break off and drift around in the marginal ice zone. Core samples from these pieces of ice provide invaluable data on microbial life, carbon levels, sea temperature and ocean currents which are collected and stored in the layers as they drift around.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/claw/agulhas-ice-floes-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/claw/agulhas-ice-floes-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/claw/agulhas-ice-floes-1400.webp"/> <img src="/assets/img/claw/agulhas-ice-floes.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> S.A. Agulhas II pushing through the marginal ice zone surrounded by ice floes. </div> <p>Currently the research group would use a net and suspended ‘wranglers’ to catch an ice floe as it drifted past, however, only the smallest floes could be collected due to the breaking strength of the net and difficulty in enveloping the ice in the net.</p> <p>For the proposal we designed a novel claw mechanism which used the weight of the ice to grip down harder for heavier pieces of ice. The design was simple and cost effective because it did not require any hydraulic actuation and could be attached directly to the existing cranes on the ship.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/claw/rendering-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/claw/rendering-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/claw/rendering-1400.webp"/> <img src="/assets/img/claw/rendering.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Rendering of the proposed ice claw. Pulling on the central cables causes the claws to close and clamp onto pieces of ice. </div> <p>We also prototyped the claw in the UCT swimming pool with scale ice floes frozen in the walk-in HW Pearson building freezers.</p> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/claw/prototype-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/claw/prototype-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/claw/prototype-1400.webp"/> <img src="/assets/img/claw/prototype.jpeg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Prototype of the claw to test the clamping mechanism. </div>]]></content><author><name></name></author><category term="Mechanical"/><summary type="html"><![CDATA[A claw for catching ice floes]]></summary></entry></feed>